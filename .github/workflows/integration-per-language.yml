name: Integration Test for a Single Language
on:
  workflow_call:
    inputs:
      language:
        description: "The language to test"
        required: true
        type: string
      repo:
        description: "The repo to test"
        required: true
        type: string
jobs:
  helm-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary
      - run: chmod +x ./draft
      - run: mkdir ./langtest
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ inputs.repo }}
          path: ./langtest
      - name: Execute Dry Run with config file
        run: |
          mkdir -p test/temp
          ./draft --dry-run --dry-run-file test/temp/dry-run.json \
          create -c ./test/integration/${{inputs.language}}/helm.yaml \
          -d ./langtest/ --skip-file-detection
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/dry_run_schema.json -d test/temp/dry-run.json
      - name: Execute Dry Run with variables passed through flag
        run: |
          mkdir -p test/temp
          ./draft --dry-run --dry-run-file test/temp/dry-run.json \
          create \
          -d ./langtest/ \
          -l ${{inputs.language}} \
          --skip-file-detection \
          --deploy-type helm \
          --variable PORT=8080 \
          --variable APPNAME=testingCreateCommand \
          --variable VERSION=1.11 \
          --variable BUILDERVERSION=1.11 \
          --variable SERVICEPORT=8080 \
          --variable NAMESPACE=testNamespace \
          --variable IMAGENAME=testImage \
          --variable IMAGETAG=latest \
          --variable ENTRYPOINT=myapp.py
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/dry_run_schema.json -d test/temp/dry-run.json
  helm-create-update:
    runs-on: ubuntu-latest
    needs: helm-dry-run
    env:
      imagetag: latest
      serviceport: 80
      ingress_test_args: "-a webapp_routing --variable ingress-tls-cert-keyvault-uri=test.cert.keyvault.uri --variable ingress-use-osm-mtls=true --variable ingress-host=host1"
      registry_port: 5000
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary
      - run: chmod +x ./draft
      - run: mkdir ./langtest
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ inputs.repo }}
          path: ./langtest
      - run: |
          rm -rf ./langtest/manifests
          rm -f ./langtest/Dockerfile ./langtest/.dockerignore
          rm -rf ./langtest/charts
          rm -rf ./langtest/base
          rm -rf ./langtest/overlays
      - run: ./draft -v create -c ./test/integration/${{inputs.language}}/helm.yaml -d ./langtest/ --skip-file-detection
      - id: kind-registry
        uses: ./.github/actions/setup-kind-registry
        with:
          registry-port: ${{ env.registry_port }}
      - name: Set image name
        run: |
          echo "imagename=${{ steps.kind-registry.outputs.local-registry }}/testapp" >> "$GITHUB_ENV"
      # Runs Helm to create manifest files
      - name: Bake deployment
        uses: azure/k8s-bake@v3.0.4
        with:
          renderEngine: "helm"
          helmChart: ./langtest/charts
          overrideFiles: ./langtest/charts/values.yaml
          overrides: |
            replicas:2
            image.repository:${{ env.imagename }}
            image.tag:${{ env.imagetag }}
          helm-version: "v3.19.2"
          releaseName: "test-release"
        id: bake
      - uses: ./.github/actions/buildx-push-image
        with:
          dockerfile: ./langtest/Dockerfile
          image: ${{ env.imagename }}
          cache-scope: ${{ inputs.language }}-helm
          context: ./langtest/
      # Deploys application based on manifest files from previous step
      - name: Deploy application
        uses: Azure/k8s-deploy@v5
        continue-on-error: true
        id: deploy
        with:
          action: deploy
          manifests: ${{ steps.bake.outputs.manifestsBundle }}
          images: |
            ${{ env.imagename }}
          timeout: ${{ inputs.language == 'swift' && '5m' || '1m' }}
      - name: Wait for rollout
        continue-on-error: true
        id: rollout
        run: |
          kubectl rollout status deployment/test-release-testapp --timeout=2m
      - name: Print K8s Objects
        if: always()
        run: |
          kubectl get po -o json
          kubectl get svc -o json
          kubectl get deploy -o json
      - name: Print Pod Logs
        if: always()
        run: |
          echo "=== Deployment Logs ==="
          kubectl logs -l app.kubernetes.io/instance=test-release --all-containers=true --ignore-errors=true || true
          echo "=== Pod Descriptions ==="
          kubectl describe pods -l app.kubernetes.io/instance=test-release || true
      - uses: ./.github/actions/curl-port-forward
        with:
          service: test-release-testapp
          port: ${{ env.serviceport }}
      - run: |
          ./draft -v generate-workflow \
          -d ./langtest/ \
          --deploy-type helm \
          --variable WORKFLOWNAME=someWorkflow \
          --variable BRANCHNAME=main \
          --variable ACRRESOURCEGROUP=someAcrResourceGroup \
          --variable AZURECONTAINERREGISTRY=someRegistry \
          --variable CONTAINERNAME=someContainer \
          --variable CLUSTERRESOURCEGROUP=someClusterResourceGroup \
          --variable CLUSTERNAME=someAksCluster \
          --variable DOCKERFILE=./Dockerfile \
          --variable BUILDCONTEXTPATH=. \
          --variable NAMESPACE=default
          pwd
      # Validate generated workflow yaml
      - name: Install action-validator with asdf
        uses: asdf-vm/actions/install@v4
        with:
          tool_versions: |
            action-validator 0.1.2
      - name: Lint Actions
        run: |
          find ./langtest/.github/workflows -type f \( -iname \*.yaml -o -iname \*.yml \) \
            | xargs -I {} action-validator --verbose {}
      - name: Execute dry run for update command
        run: |
          mkdir -p test/temp
          pwd
          ./draft --dry-run --dry-run-file test/temp/update_dry_run.json update -d ./langtest/ ${{ env.ingress_test_args }}
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/update_dry_run_schema.json -d test/temp/update_dry_run.json
      - run: ./draft -v update -d ./langtest/ ${{ env.ingress_test_args }}
      - name: Fail if any error
        if: steps.deploy.outcome != 'success'
        run: |
          kubectl get po
          echo "Deployment failed, check above logs and previous steps to isolate the issue"
          exit 6
  kustomize-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary
      - run: chmod +x ./draft
      - run: mkdir ./langtest
      - uses: actions/checkout@v6.0.2
        with:
          repository: ${{ inputs.repo }}
          path: ./langtest
      - name: Execute Dry Run with config file
        run: |
          mkdir -p test/temp
          ./draft --dry-run --dry-run-file test/temp/dry-run.json \
          create -c ./test/integration/${{inputs.language}}/kustomize.yaml \
          -d ./langtest/ --skip-file-detection
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/dry_run_schema.json -d test/temp/dry-run.json
      - name: Execute Dry Run with variables passed through flag
        run: |
          mkdir -p test/temp
          ./draft --dry-run --dry-run-file test/temp/dry-run.json \
          create \
          -d ./langtest/ \
          -l ${{inputs.language}} \
          --skip-file-detection \
          --deploy-type kustomize \
          --variable PORT=8080 \
          --variable APPNAME=testingCreateCommand \
          --variable VERSION=1.11 \
          --variable BUILDERVERSION=1.11 \
          --variable SERVICEPORT=8080 \
          --variable NAMESPACE=testNamespace \
          --variable IMAGENAME=testImage \
          --variable IMAGETAG=latest \
          --variable ENTRYPOINT=myapp.py
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/dry_run_schema.json -d test/temp/dry-run.json
  kustomize-create-update:
    runs-on: ubuntu-latest
    needs: kustomize-dry-run
    env:
      imagetag: latest
      serviceport: 80
      ingress_test_args: "-a webapp_routing --variable ingress-tls-cert-keyvault-uri=test.cert.keyvault.uri --variable ingress-use-osm-mtls=true --variable ingress-host=host1"
      registry_port: 5000
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary
      - run: chmod +x ./draft
      - run: mkdir ./langtest
      - uses: actions/checkout@v6.0.2
        with:
          repository: ${{inputs.repo}}
          path: ./langtest
      - run: |
          rm -rf ./langtest/manifests
          rm -f ./langtest/Dockerfile ./langtest/.dockerignore
          rm -rf ./langtest/charts
          rm -rf ./langtest/base
          rm -rf ./langtest/overlays
      - run: ./draft -v create -c ./test/integration/${{inputs.language}}/kustomize.yaml -d ./langtest/
      - id: kind-registry
        uses: ./.github/actions/setup-kind-registry
        with:
          registry-port: ${{ env.registry_port }}
      - name: Set image name
        run: |
          echo "imagename=${{ steps.kind-registry.outputs.local-registry }}/testapp" >> "$GITHUB_ENV"
      - name: Bake deployment
        uses: azure/k8s-bake@v3.0.4
        id: bake
        with:
          renderEngine: "kustomize"
          kustomizationPath: ./langtest/base
          kubectl-version: "latest"
      - uses: ./.github/actions/buildx-push-image
        with:
          dockerfile: ./langtest/Dockerfile
          image: ${{ env.imagename }}
          cache-scope: ${{ inputs.language }}-kustomize
          context: ./langtest/
      # Deploys application based on manifest files from previous step
      - name: Deploy application
        uses: Azure/k8s-deploy@v5
        continue-on-error: true
        id: deploy
        with:
          action: deploy
          manifests: ${{ steps.bake.outputs.manifestsBundle }}
          images: |
            ${{ env.imagename }}
          timeout: ${{ inputs.language == 'swift' && '5m' || '1m' }}
      - name: Wait for rollout
        continue-on-error: true
        id: rollout
        run: |
          kubectl rollout status deployment/testapp --timeout=2m
      - name: Print K8s Objects
        if: always()
        run: |
          kubectl get po -o json
          kubectl get svc -o json
          kubectl get deploy -o json
      - name: Print Pod Logs
        if: always()
        run: |
          echo "=== Deployment Logs ==="
          kubectl logs -l app=testapp --all-containers=true --ignore-errors=true || true
          echo "=== Pod Descriptions ==="
          kubectl describe pods -l app=testapp || true
      - uses: ./.github/actions/curl-port-forward
        with:
          service: testapp
          port: ${{ env.serviceport }}
      - run: |
          ./draft -v generate-workflow \
          -d ./langtest/ \
          --deploy-type kustomize \
          --variable WORKFLOWNAME=someWorkflow \
          --variable BRANCHNAME=main \
          --variable ACRRESOURCEGROUP=someAcrResourceGroup \
          --variable AZURECONTAINERREGISTRY=someRegistry \
          --variable CONTAINERNAME=someContainer \
          --variable CLUSTERRESOURCEGROUP=someClusterResourceGroup \
          --variable CLUSTERNAME=someAksCluster \
          --variable DOCKERFILE=./Dockerfile \
          --variable BUILDCONTEXTPATH=. \
          --variable NAMESPACE=default
          pwd
      # Validate generated workflow yaml
      - name: Install action-validator with asdf
        uses: asdf-vm/actions/install@v4
        with:
          tool_versions: |
            action-validator 0.1.2
      - name: Lint Actions
        run: |
          find ./langtest/.github/workflows -type f \( -iname \*.yaml -o -iname \*.yml \) \
            | xargs -I {} action-validator --verbose {}
      - name: Execute dry run for update command
        run: |
          mkdir -p test/temp
          ./draft --dry-run --dry-run-file test/temp/update_dry_run.json update -d ./langtest/ $ingress_test_args
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/update_dry_run_schema.json -d test/temp/update_dry_run.json
      - run: ./draft -v update -d ./langtest/ $ingress_test_args
      - name: Check default namespace
        if: steps.deploy.outcome != 'success'
        run: |
          kubectl get po
          echo "Deployment failed, check above logs and previous steps to isolate the issue"
          exit 6
  manifests-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary
      - run: chmod +x ./draft
      - run: mkdir ./langtest
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ inputs.repo }}
          path: ./langtest
      - name: Execute Dry Run with config file
        run: |
          mkdir -p test/temp
          ./draft --dry-run --dry-run-file test/temp/dry-run.json \
          create -c ./test/integration/${{inputs.language}}/manifest.yaml \
          -d ./langtest/ --skip-file-detection
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/dry_run_schema.json -d test/temp/dry-run.json
      - name: Execute Dry Run with variables passed through flag
        run: |
          mkdir -p test/temp
          ./draft -v --dry-run --dry-run-file test/temp/dry-run.json \
          create \
          -d ./langtest/ \
          -l ${{inputs.language}} \
          --skip-file-detection \
          --deploy-type manifests \
          --variable PORT=8080 \
          --variable APPNAME=testingCreateCommand \
          --variable VERSION=1.11 \
          --variable BUILDERVERSION=1.11 \
          --variable SERVICEPORT=80 \
          --variable NAMESPACE=testNamespace \
          --variable IMAGENAME=testImage \
          --variable IMAGETAG=latest \
          --variable ENTRYPOINT=myapp.py
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/dry_run_schema.json -d test/temp/dry-run.json
  manifests-create:
    runs-on: ubuntu-latest
    needs: manifests-dry-run
    env:
      imagename: localhost:5000/testapp
      serviceport: 80
      ingress_test_args: "-a webapp_routing --variable ingress-tls-cert-keyvault-uri=test.cert.keyvault.uri --variable ingress-use-osm-mtls=true --variable ingress-host=host1"
      registry_port: 5000
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary
      - run: chmod +x ./draft
      - run: mkdir ./langtest
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ inputs.repo }}
          path: ./langtest
      - run: |
          rm -rf ./langtest/manifests
          rm -f ./langtest/Dockerfile ./langtest/.dockerignore
          rm -rf ./langtest/charts
          rm -rf ./langtest/base
          rm -rf ./langtest/overlays
      - run: ./draft -v create -c ./test/integration/${{inputs.language}}/manifest.yaml -d ./langtest/ --skip-file-detection
      - name: print manifests
        run: cat ./langtest/manifests/*
      - name: Add docker.local host to /etc/hosts
        run: |
          sudo echo \"127.0.0.1 docker.local\" | sudo tee -a /etc/hosts
      - id: kind-registry
        uses: ./.github/actions/setup-kind-registry
        with:
          registry-port: ${{ env.registry_port }}
      - uses: ./.github/actions/buildx-push-image
        with:
          dockerfile: ./langtest/Dockerfile
          image: ${{ steps.kind-registry.outputs.local-registry }}/testapp
          cache-scope: ${{ inputs.language }}-manifests
          context: ./langtest/
      # Deploys application based on manifest files from previous step
      - name: Deploy application
        run: kubectl apply -f ./langtest/manifests/
        continue-on-error: true
        id: deploy
      - name: Patch image for localhost registry
        run: |
          kubectl patch deployment/testapp -p '{"spec":{"template":{"spec":{"containers":[{"name":"testapp","image":"${{ steps.kind-registry.outputs.local-registry }}/testapp"}]}}}}'
          kubectl rollout status deployment/testapp --timeout=5m
      - name: Wait for rollout
        continue-on-error: true
        id: rollout
        run: |
          kubectl rollout status deployment/testapp --timeout=2m
      - name: Print K8s Objects
        if: always()
        run: |
          kubectl get po -o json
          kubectl get svc -o json
          kubectl get deploy -o json
      - name: Print Pod Logs
        if: always()
        run: |
          echo "=== Deployment Logs ==="
          kubectl logs -l app=testapp --all-containers=true --ignore-errors=true || true
          echo "=== Pod Descriptions ==="
          kubectl describe pods -l app=testapp || true
      - uses: ./.github/actions/curl-port-forward
        with:
          service: testapp
          port: ${{ env.serviceport }}
      - run: |
          ./draft -v generate-workflow \
          -d ./langtest/ \
          --deploy-type manifests \
          --variable WORKFLOWNAME=someWorkflow \
          --variable BRANCHNAME=main \
          --variable ACRRESOURCEGROUP=someAcrResourceGroup \
          --variable AZURECONTAINERREGISTRY=someRegistry \
          --variable CONTAINERNAME=someContainer \
          --variable CLUSTERRESOURCEGROUP=someClusterResourceGroup \
          --variable CLUSTERNAME=someAksCluster \
          --variable DOCKERFILE=./Dockerfile \
          --variable BUILDCONTEXTPATH=. \
          --variable NAMESPACE=default
      # Validate generated workflow yaml
      - name: Install action-validator with asdf
        uses: asdf-vm/actions/install@v4
        with:
          tool_versions: |
            action-validator 0.1.2
      - name: Lint Actions
        run: |
          find ./langtest/.github/workflows -type f \( -iname \*.yaml -o -iname \*.yml \) \
            | xargs -I {} action-validator --verbose {}
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{inputs.language}}-manifests-create
          path: |
            ./langtest
            !./langtest/**/.git/*
      - name: Fail if any error
        if: steps.deploy.outcome != 'success' || steps.rollout.outcome != 'success'
        run: exit 6
  manifest-update:
    needs: manifests-create
    runs-on: ubuntu-latest
    env:
      ingress_test_args: "-a webapp_routing --variable ingress-tls-cert-keyvault-uri=test.cert.keyvault.uri --variable ingress-use-osm-mtls=true --variable ingress-host=host1"
      imagename: localhost:5000/testapp
      registry_port: 5000
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary
      - run: chmod +x ./draft
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{inputs.language}}-manifests-create
          path: ./langtest/
      - name: Execute dry run for update command
        run: |
          mkdir -p test/temp
          ./draft --dry-run --dry-run-file test/temp/update_dry_run.json update -d ./langtest/ ${{env.ingress_test_args}}
      - name: Validate JSON
        run: |
          npm install -g ajv-cli@5.0.0
          ajv validate -s test/update_dry_run_schema.json -d test/temp/update_dry_run.json
      - run: ./draft -v update -d ./langtest/ ${{ env.ingress_test_args }}
      - id: kind-registry
        uses: ./.github/actions/setup-kind-registry
        with:
          registry-port: ${{ env.registry_port }}
      - uses: ./.github/actions/buildx-push-image
        with:
          dockerfile: ./langtest/Dockerfile
          image: ${{ steps.kind-registry.outputs.local-registry }}/testapp
          cache-scope: ${{ inputs.language }}-manifest-update
          context: ./langtest/
      # Deploys application based on manifest files from previous step
      - name: Deploy application
        run: kubectl apply -f ./langtest/manifests/
        continue-on-error: true
        id: deploy
      - name: Patch image for localhost registry
        run: |
          kubectl patch deployment/testapp -p '{"spec":{"template":{"spec":{"containers":[{"name":"testapp","image":"${{ steps.kind-registry.outputs.local-registry }}/testapp"}]}}}}'
          kubectl rollout status deployment/testapp --timeout=5m
      - name: Fail if any error
        if: steps.deploy.outcome != 'success'
        run: |
          kubectl get po
          echo "Deployment failed, check above logs and previous steps to isolate the issue"
          exit 6
  win-helm-create:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary-win
      - run: mkdir ./langtest
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ inputs.repo }}
          path: ./langtest
      - run: Remove-Item ./langtest/manifests -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/base -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/overlays -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/charts -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/Dockerfile -ErrorAction Ignore
      - run: Remove-Item ./langtest/.dockerignore -ErrorAction Ignore
      - run: ./draft.exe -v create -c ./test/integration/${{inputs.language}}/helm.yaml -d ./langtest/
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: check_windows_helm
          path: ./langtest/
      - run: ./check_windows_helm.ps1
        working-directory: ./langtest/
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{inputs.language}}-win-helm-create
          path: |
            ./langtest
            !./langtest/**/.git/*
  win-helm-update:
    needs: win-helm-create
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary-win
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{inputs.language}}-win-helm-create
          path: ./langtest/
      - run: Remove-Item ./langtest/charts/templates/ingress.yaml -Recurse -Force -ErrorAction Ignore
      - run: ./draft.exe -v update -d ./langtest/ -a webapp_routing --variable ingress-tls-cert-keyvault-uri=test.cert.keyvault.uri --variable ingress-use-osm-mtls=true --variable ingress-host=host1
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: check_windows_addon_helm
          path: ./langtest/
      - run: ./check_windows_addon_helm.ps1
        working-directory: ./langtest/
  win-kustomize-create:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary-win
      - run: mkdir ./langtest
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ inputs.repo }}
          path: ./langtest
      - run: Remove-Item ./langtest/manifests -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/base -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/overlays -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/charts -Recurse -Force -ErrorAction Ignore
      - run: Remove-Item ./langtest/Dockerfile -ErrorAction Ignore
      - run: Remove-Item ./langtest/.dockerignore -ErrorAction Ignore
      - run: ./draft.exe -v create -c ./test/integration/${{ inputs.language }}/kustomize.yaml -d ./langtest/
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: check_windows_kustomize
          path: ./langtest/
      - run: ./check_windows_kustomize.ps1
        working-directory: ./langtest/
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ inputs.language }}-win-kustomize-create
          path: |
            ./langtest
            !./langtest/**/.git/*
  win-kustomize-update:
    needs: win-kustomize-create
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: draft-binary-win
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{inputs.language}}-win-kustomize-create
          path: ./langtest
      - run: Remove-Item ./langtest/overlays/production/ingress.yaml -ErrorAction Ignore
      - run: ./draft.exe -v update -d ./langtest/ -a webapp_routing --variable ingress-tls-cert-keyvault-uri=test.cert.keyvault.uri --variable ingress-use-osm-mtls=true --variable ingress-host=host1
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: check_windows_addon_kustomize
          path: ./langtest/
      - run: ./check_windows_addon_kustomize.ps1
        working-directory: ./langtest/
