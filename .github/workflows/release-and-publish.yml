name: Draft Release & Publish
on: [workflow_dispatch]

jobs:
  Release-Artifacts:
    name: release
    runs-on: ubuntu-latest
    steps:
    # Checkcout code
    - name: Checkout
      uses: actions/checkout@v2
    # Read changelog and read versions etc.
    - name: Check version is mentioned in Changelog
      id: changelog_reader
      uses: mindsers/changelog-reader-action@v2
      with:
        validation_depth: 10
        path: './CHANGELOG.md'
    # Set the DRAFT_VERSION variable
    - name: Set the draft version value
      id: step_one
      run: |
        echo "${{ steps.changelog_reader.outputs.version }} ++ ${{ steps.changelog_reader.outputs.version }}"
        echo "${{ steps.changelog_reader.outputs.changes }}"
        echo "DRAFT_VERSION=${{ steps.changelog_reader.outputs.version }}" >> $GITHUB_ENV
    - name: Check the value is set for draft version
      id: step_two
      run: |
        echo "${{ env.DRAFT_VERSION }}" & echo "test var value set: $DRAFT_VERSION" # This will output to the env var
    # Do the build etc and make it part of that release.
    - name: Make Release Dir
      run: mkdir bin
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.18.2
    - name: Build Release Binaries
      run: make build-all
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./bin/*
    # Create release tag out of Changelog entry
    - name: Create a Release
      id: create_release
      uses: actions/create-release@v1
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
      with:
        tag_name : ${{ teps.changelog_reader.outputs.version }}
        release_name: ${{ teps.changelog_reader.outputs.version }}
        body: Publish ${{ steps.changelog_reader.outputs.changes }}
